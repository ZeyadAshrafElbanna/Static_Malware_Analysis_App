import os
import hashlib
from datetime import datetime
import shutil
from config import *
import pdfkit
import pefile
import requests
import bs4

class StaticMalwareAnalysis:
    def __init__(self, sample_name):
        self.path = config['malware-sample-folder']
        self.saved_analysis_folder = config['saved-analysis']
        self.sample_file = sample_name                                  # malware-folder/mal.exe
        self.sample_name = os.path.basename(sample_name)                # mal.exe
        self.sample_name_dir = ""                                       # saved-analysis/mal.exe-timestamp/
        self.information = {
            "archirecture": "",
            "sha256_hash" : "",
            "malicious_api": [],
            "other_api" : [],
            "virustotal_results": "",
            "strings" : "",
            "sections": [],
            "saved_to": ""
        }
        
    @staticmethod
    def check_malware_sample_exists():
        path = config['malware-sample-folder']
        if not os.path.exists(path):
            os.mkdir(path)
            print("Malware Sample Folder doesnot exist. Created folder.")
            return False
        elif len(os.listdir(path)) == 0:
            print("Malware Sample directory is empty. Please add malware to start static analysis")
            return False
        return True
    
    
    def create_directory(self):
        if not os.path.exists(self.saved_analysis_folder):
            os.mkdir(self.saved_analysis_folder)
        sample_name_dir = self.sample_name + "_" + str(datetime.now()).replace(" ","-").replace(":","").replace(".","")
        os.mkdir(os.path.join(self.saved_analysis_folder,sample_name_dir))
        self.sample_name_dir = os.path.join(self.saved_analysis_folder,sample_name_dir)
        return sample_name_dir
    
    def get_sha256sum(self):
        hash_function = hashlib.sha256()
        with open(self.sample_file, "rb") as f:
            for byte_block in iter(lambda: f.read(4096), b""):
                hash_function.update(byte_block)
            hash_value = hash_function.hexdigest()
        self.information['sha256_hash'] = hash_value
        return hash_value
    
    def malAPICheck(self,api):
        api_request = requests.get("https://malapi.io/winapi/" + api)
        api_request.raise_for_status()
        api_data = bs4.BeautifulSoup(api_request.text, 'html.parser')
        
        if "404 Not Found" in api_data.getText():
            print(f"API NOT FOUND - {api}")
            return "No result", "No result"

        details = api_data.select('.detail-container .content')
        api_description = details[1].getText().lstrip().rstrip()
        api_associated_attacks = " ".join(details[3].getText().lstrip().rstrip().split())
        print(f"API FOUND - {api}")
        return api_description, api_associated_attacks
    
    def extractPEINFO(self):
        try:
            pe = pefile.PE(self.sample_file)

            if hex(pe.FILE_HEADER.Machine) == '0x14c':
                self.information['archirecture'] = "32 bit binary"
            else:
                self.information['archirecture'] = "64 bit binary"

            for section in pe.sections:
                section_name = section.Name.decode().rstrip('\x00')
                self.information['sections'].append((
                    f"{section_name}",
                    hex(section.Misc_VirtualSize),
                    hex(section.SizeOfRawData),
                    str(hex(section.Misc_VirtualSize) > hex(section.SizeOfRawData))
                ))

            pe.parse_data_directories()
            for entry in pe.DIRECTORY_ENTRY_IMPORT:
                for imp in entry.imports:
                    api = imp.name.decode("utf-8")
                    try:
                        if api[0] != '_':
                            desc, tags = self.malAPICheck(api)
                            if desc == "No result" or tags == "No result":
                                self.information['other_api'].append(api)
                            else:
                                self.information['malicious_api'].append((api, desc.replace(",",""), tags))
                    except:
                        self.information['other_api'].append(api)
            return self.information
        except Exception as e:
            print("Error occurred in collecting PE Info")
            print(e)
            return False

    def move_malware(self):
        final_path = os.path.join(self.sample_name_dir, "Malware." + self.sample_name + ".malz")
        shutil.copyfile(self.sample_file, final_path)
        self.information['saved_to'] = final_path
        try:
            os.unlink(self.sample_file)
        except Exception as e:
            print(f"File delete failed - {self.sample_file}")
        return final_path

    def create_pdf(self):
        malicious_api_tbody = ""
        malicious_api = self.information['malicious_api']
        for row in malicious_api:
            name = f'<a href="https://malapi.io/winapi/{row[0]}">{row[0]}</a>'
            
            malicious_api_tbody += f"""
                <tr>
                    <td>{ name }</td>
                    <td>{row[1]}</td>
                    <td>{row[2]}</td>
                </tr>
            """

        other_api_body = ", ".join(self.information['other_api'])

        sections_tbody = ""
        sections = self.information['sections']
        for row in sections:
            sections_tbody += f"""
                <tr>
                    <td>{row[0]}</td>
                    <td>{row[1]}</td>
                    <td>{row[2]}</td>
                    <td>{row[3]}</td>
                </tr>
            """

        styles = """
            table, th, td { border: 1px solid black;border-collapse: collapse;}
            table { margin-left: auto; margin-right: auto; }
            tr,h3 { text-align: center; }
            th { padding : 10px; }
            td { padding : 3px; }
        """

        html = f"""
            <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta http-equiv="X-UA-Compatible" content="IE=edge">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>{self.sample_name}</title>
                    <style> {styles} </style>
                </head>
                <body>
                    <h3> General Information </h3>
                    <table>
                        <thead>
                            <tr>
                                <th> SHA 256 HASH </th>
                                <th> {self.information['sha256_hash']} </th>
                            </tr>
                            <tr>
                                <th> Architecture </th>
                                <th> {self.information['archirecture']} </th>
                            </tr>
                        </thead>
                    </table>
                    <br><hr/>
                    <h3> Malicious API's </h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Tags</th>
                                <th>Malicious</th>
                            </tr>
                        </thead>
                        <tbody>
                            {malicious_api_tbody}
                        </tbody>
                    </table>
                    <br><hr/>
                    <h3> Other API's </h3>
                    <p> {other_api_body} </p>
                    <br><hr/>
                    <h3> Sections </h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Virtual Size</th>
                                <th>Raw Data Size</th>
                                <th>Virtual Size >  Raw Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sections_tbody}
                        </tbody>
                    </table>
                </body>
            </html>
        """

        with open(os.path.join(self.sample_name_dir,f'{self.sample_name}.html'),"w") as html_file:
            html_file.write(html)
        
        path_to_wkhtmltopdf = config['path_to_wkhtmltopdf']

        path_to_file = os.path.join(self.sample_name_dir,f'{self.sample_name}.html')

        pdf_config = pdfkit.configuration(wkhtmltopdf=path_to_wkhtmltopdf)
        pdfkit.from_file(
            path_to_file, 
            output_path=os.path.join(self.sample_name_dir,f'{self.sample_name}.pdf'), 
            configuration=pdf_config
        )
